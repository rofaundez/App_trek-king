<ion-header class="header-container">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/my-routes"></ion-back-button>
    </ion-buttons>
    <ion-title class="titulo-header" >Crear Ruta</ion-title>
    <ion-buttons slot="end">
      <ion-button routerLink="/my-routes">
        <ion-icon name="list-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>


<ion-content>
  <div class="content-background"></div>
  <div class="container">
    <div class="header-content">
      <h1>Crear Nueva Ruta</h1>
      <p>Completa los detalles de tu ruta</p>
    </div>

    <form [formGroup]="routeForm" (ngSubmit)="onSubmit()">
      <div class="form-container">
        <div class="form-section">
          <h3>Información Básica</h3>
          <ion-item class="custom-input">
            <ion-label position="floating">Nombre de la Ruta</ion-label>
            <input formControlName="nombre" type="text" placeholder="Ej: Cerro Santa Lucía">
          </ion-item>

          <ion-item class="custom-input">
            <ion-textarea 
              formControlName="descripcion" 
              rows="4"
              placeholder="Describe la ruta, sus características y recomendaciones">
            </ion-textarea>
          </ion-item>

          <ion-item class="custom-input">
            <ion-label position="floating">Localidad</ion-label>
            <input formControlName="localidad" type="text" placeholder="Ej: Santiago, Chile">
          </ion-item>

          <ion-item class="custom-input">
            <ion-label position="floating">Dificultad</ion-label>
            <ion-select formControlName="dificultad" interface="action-sheet">
              <ion-select-option value="Fácil">Fácil</ion-select-option>
              <ion-select-option value="Moderada">Moderada</ion-select-option>
              <ion-select-option value="Difícil">Difícil</ion-select-option>
              <ion-select-option value="Muy Difícil">Muy Difícil</ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <div class="form-section">
          <h3>Imagen de la Ruta</h3>
          <div class="image-upload">
            <ion-button class="upload-button" (click)="fileInput.click()">
              <ion-icon name="image-outline" slot="start"></ion-icon>
              Seleccionar Imagen
            </ion-button>
            <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
          </div>
          <div class="image-preview" *ngIf="imagePreview">
            <img [src]="imagePreview" alt="Preview">
          </div>
        </div>

        <div class="form-section">
          <h3>Ubicación</h3>
          <div class="location-point">
            <h4>Punto de Inicio</h4>
            <ion-button expand="block" class="map-button" (click)="openMapModal('start')">
              <ion-icon name="map-outline" slot="start"></ion-icon>
              Seleccionar punto de inicio en el mapa
            </ion-button>
            <ion-item class="custom-input">
              <ion-label position="floating">Dirección</ion-label>
              <input formControlName="puntoInicioDireccion" readonly>
            </ion-item>
            <div class="coordinates-container">
              <ion-item class="custom-input">
                <ion-label position="floating">Latitud</ion-label>
                <input formControlName="puntoInicioLat" type="number" readonly>
              </ion-item>
              <ion-item class="custom-input">
                <ion-label position="floating">Longitud</ion-label>
                <input formControlName="puntoInicioLng" type="number" readonly>
              </ion-item>
            </div>
          </div>

          <div class="location-point">
            <h4>Punto de Término</h4>
            <ion-button expand="block" class="map-button" (click)="openMapModal('end')">
              <ion-icon name="map-outline" slot="start"></ion-icon>
              Seleccionar punto de término en el mapa
            </ion-button>
            <ion-item class="custom-input">
              <ion-label position="floating">Dirección</ion-label>
              <input formControlName="puntoTerminoDireccion" readonly>
            </ion-item>
            <div class="coordinates-container">
              <ion-item class="custom-input">
                <ion-label position="floating">Latitud</ion-label>
                <input formControlName="puntoTerminoLat" type="number" readonly>
              </ion-item>
              <ion-item class="custom-input">
                <ion-label position="floating">Longitud</ion-label>
                <input formControlName="puntoTerminoLng" type="number" readonly>
              </ion-item>
            </div>
          </div>
        </div>

        <ion-button expand="block" type="submit" class="submit-button" [disabled]="!routeForm.valid || !selectedFile">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Crear Ruta
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>
<app-footer></app-footer>

<!-- Map Modal -->
<ion-modal [isOpen]="isMapModalOpen" (didDismiss)="closeMapModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{currentLocationType === 'start' ? 'Seleccionar Punto de Inicio' : 'Seleccionar Punto de Término'}}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeMapModal()" class="confirm-button">
            <ion-icon name="checkmark-outline" slot="start"></ion-icon>
            Confirmar
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <div class="map-container">
        <div id="map" *ngIf="!mapError"></div>
        
        <div class="loading-container" *ngIf="isMapLoading">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Cargando mapa...</p>
        </div>

        <div class="error-container" *ngIf="mapError">
          <ion-icon name="alert-circle-outline" size="large"></ion-icon>
          <p>No se pudo cargar el mapa</p>
          <ion-button (click)="openMapModal(currentLocationType!)" class="retry-button">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Reintentar
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
