<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/my-routes"></ion-back-button>
    </ion-buttons>
    <ion-title>Crear Nueva Ruta</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="container">
    <div class="header-container">
      <h1>Crear Nueva Ruta</h1>
      <p>Completa los detalles de tu ruta</p>
    </div>

    <form [formGroup]="routeForm" (ngSubmit)="onSubmit()">
      <div class="form-container">
        <div class="form-section">
          <h3>Información Básica</h3>
          <ion-item class="custom-input">
            <ion-label position="floating">Nombre de la Ruta</ion-label>
            <ion-input formControlName="nombre" type="text" placeholder="Ej: Cerro Santa Lucía"></ion-input>
          </ion-item>

          <ion-item class="custom-input">
            <ion-label position="floating">Descripción</ion-label>
            <ion-textarea 
              formControlName="descripcion" 
              rows="4"
              placeholder="Describe la ruta, sus características y recomendaciones">
            </ion-textarea>
          </ion-item>

          <ion-item class="custom-input">
            <ion-label position="floating">Localidad</ion-label>
            <ion-input formControlName="localidad" type="text" placeholder="Ej: Santiago, Chile"></ion-input>
          </ion-item>

          <ion-item class="custom-input">
            <ion-label position="floating">Dificultad</ion-label>
            <ion-select formControlName="dificultad" interface="action-sheet">
              <ion-select-option value="Fácil">Fácil</ion-select-option>
              <ion-select-option value="Moderada">Moderada</ion-select-option>
              <ion-select-option value="Difícil">Difícil</ion-select-option>
              <ion-select-option value="Muy Difícil">Muy Difícil</ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <div class="form-section">
          <h3>Imagen de la Ruta</h3>
          <div class="image-upload">
            <ion-button class="upload-button" (click)="fileInput.click()">
              <ion-icon name="image-outline" slot="start"></ion-icon>
              Seleccionar Imagen
            </ion-button>
            <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
          </div>
          <div class="image-preview" *ngIf="imagePreview">
            <img [src]="imagePreview" alt="Preview">
          </div>
        </div>

        <div class="form-section">
          <h3>Ubicación</h3>
          <div class="location-point">
            <h4>Punto de Inicio</h4>
            <ion-button expand="block" (click)="openMapModal('start')">
              <ion-icon name="map-outline" slot="start"></ion-icon>
              Seleccionar punto de inicio en el mapa
            </ion-button>
            <ion-item class="custom-input">
              <ion-label position="floating">Dirección</ion-label>
              <ion-input formControlName="puntoInicioDireccion" readonly></ion-input>
            </ion-item>
            <div class="coordinates-container">
              <ion-item class="custom-input">
                <ion-label position="floating">Latitud</ion-label>
                <ion-input formControlName="puntoInicioLat" type="number" readonly></ion-input>
              </ion-item>
              <ion-item class="custom-input">
                <ion-label position="floating">Longitud</ion-label>
                <ion-input formControlName="puntoInicioLng" type="number" readonly></ion-input>
              </ion-item>
            </div>
          </div>

          <div class="location-point">
            <h4>Punto de Término</h4>
            <ion-button expand="block" (click)="openMapModal('end')">
              <ion-icon name="map-outline" slot="start"></ion-icon>
              Seleccionar punto de término en el mapa
            </ion-button>
            <ion-item class="custom-input">
              <ion-label position="floating">Dirección</ion-label>
              <ion-input formControlName="puntoTerminoDireccion" readonly></ion-input>
            </ion-item>
            <div class="coordinates-container">
              <ion-item class="custom-input">
                <ion-label position="floating">Latitud</ion-label>
                <ion-input formControlName="puntoTerminoLat" type="number" readonly></ion-input>
              </ion-item>
              <ion-item class="custom-input">
                <ion-label position="floating">Longitud</ion-label>
                <ion-input formControlName="puntoTerminoLng" type="number" readonly></ion-input>
              </ion-item>
            </div>
          </div>
        </div>

        <ion-button expand="block" type="submit" class="submit-button" [disabled]="!routeForm.valid || !selectedFile">
          Crear Ruta
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>

<!-- Map Modal -->
<ion-modal [isOpen]="isMapModalOpen" (didDismiss)="closeMapModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{currentLocationType === 'start' ? 'Seleccionar Punto de Inicio' : 'Seleccionar Punto de Término'}}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeMapModal()">Confirmar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <div class="map-container">
        <div id="map" *ngIf="!mapError"></div>
        
        <div class="loading-container" *ngIf="isMapLoading">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Cargando mapa...</p>
        </div>

        <div class="error-container" *ngIf="mapError">
          <ion-icon name="alert-circle-outline" size="large"></ion-icon>
          <p>No se pudo cargar el mapa</p>
          <ion-button (click)="openMapModal(currentLocationType!)">
            Reintentar
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<style>
.map-container {
  width: 100%;
  height: 100%;
  
  #map {
    width: 100%;
    height: 100%;
  }
}

.loading-container,
.error-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  width: 100%;
  
  ion-spinner {
    margin-bottom: 1rem;
  }
}

.coordinates-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-top: 1rem;
}
</style>
